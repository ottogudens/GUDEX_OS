
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =================================
    //  Helper Functions
    // =================================
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // More robust helper functions that check for document existence
    // before trying to access properties. This prevents errors on
    // non-existent documents, which would cause a permission denial.
    function getUserRole() {
      // Safely get the user's role, returning null if it doesn't exist.
      let userDocPath = /databases/$(database)/documents/users/$(request.auth.uid);
      if (exists(userDocPath)) {
        return get(userDocPath).data.role;
      }
      return null;
    }

    function isAdmin() {
      return isSignedIn() && getUserRole() == 'Administrador';
    }
    
    function isStaff() {
      let userRole = getUserRole();
      return isSignedIn() && (userRole == 'Administrador' || userRole == 'Mecanico');
    }
    
    function isClient() {
      return isSignedIn() && getUserRole() == 'Cliente';
    }

    // =================================
    //  Collection Rules
    // =================================

    // Settings
    match /settings/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Users and Customers (document ID is the user UID)
    match /users/{userId} {
      allow read, update: if isAdmin() || isOwner(userId);
      allow create, delete: if isAdmin();
    }

    match /customers/{userId} {
      allow read: if isStaff() || isOwner(userId);
      allow create: if isStaff() || (isSignedIn() && request.resource.data.email == request.auth.token.email);
      allow update: if isAdmin() || isOwner(userId);
      allow delete: if isAdmin();
    }
    
    // Vehicles
    match /vehicles/{vehicleId} {
        allow create: if (isClient() && request.resource.data.customerId == request.auth.uid) || isStaff();
        allow read: if (isClient() && resource.data.customerId == request.auth.uid) || isStaff();
        allow update: if (isClient() && resource.data.customerId == request.auth.uid) || isStaff();
        allow delete: if isStaff();
    }

    // Products & Services
    match /products/{productId} {
      allow read: if isStaff();
      allow create, delete: if isAdmin();
      allow update: if isAdmin() || (isStaff() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['stock']));
    }
    
    match /services/{serviceId} {
      allow read: if isStaff();
      allow create, update, delete: if isAdmin();
    }

    // Categories
    match /productCategories/{categoryId} {
        allow read: if isStaff();
        allow create, update, delete: if isAdmin();
    }
    match /serviceCategories/{categoryId} {
        allow read: if isStaff();
        allow create, update, delete: if isAdmin();
    }

    // Stock Logs
    match /stockLogs/{logId} {
        allow create: if isStaff();
        allow read: if isStaff();
    }
    
    // Workshop operations
    match /appointments/{appointmentId} {
      allow read: if isStaff() || (isClient() && resource.data.customerId == request.auth.uid);
      allow write: if isStaff();
    }

    match /appointmentRequests/{requestId} {
      allow create: if isClient() && request.resource.data.customerId == request.auth.uid;
      allow read, delete: if isStaff();
    }
    
    // Budgets
    match /budgets/{budgetId} {
      allow read: if isAdmin() || (isClient() && resource.data.customerId == request.auth.uid);
      allow write: if isAdmin();
      allow update: if isAdmin() || (isClient() && request.resource.data.customerId == request.auth.uid);
    }

    match /budgetRequests/{requestId} {
        allow create: if isClient() && request.resource.data.customerId == request.auth.uid;
        allow read, delete: if isAdmin();
    }
    
    match /workOrders/{orderId} {
      allow create, update: if isStaff();
      allow read: if isStaff() || (isClient() && resource.data.customerId == request.auth.uid);
    }
    
    // Admin-Only Areas
    match /cameras/{cameraId} {
      allow read, write: if isAdmin();
    }
    
    match /sales/{saleId} {
      allow read: if isStaff();
      allow write: if isAdmin();
    }
    
    match /cashRegisterSessions/{sessionId} {
      // Allow any staff member to open/close the register
      allow read, write: if isStaff();
    }
    
    match /cashMovements/{movementId} {
      // Allow any staff member to add movements to an open session
      allow read, write: if isStaff();
    }

    // Receipts can be read by clients
    match /receipts/{receiptId} {
      allow create: if isAdmin();
      allow read: if isAdmin() || (isClient() && resource.data.customerId == request.auth.uid);
    }
    
    // Server-side logging
    match /emailLogs/{logId} {
        allow create: if true;
        allow read, update, delete: if isAdmin();
    }

    match /sentEmails/{emailId} {
        allow create: if true;
        allow read, update, delete: if isAdmin();
    }
  }
}
